#!/bin/bash

# tmux-hello: AI Assistant Briefing Script
# Explains the AI-workflow tmux setup in terse, LLM-friendly terms

echo
echo "=== ğŸ³ DOCKER INTEGRATION ==="
if [ "$DOCKER_MODE" = "true" ]; then
    echo "â€¢ Status: ACTIVE - Commands execute in Ubuntu container"
    echo "â€¢ Safety: Host system protected from command execution"
    echo "â€¢ Tools: Pre-installed Python, Node.js, build tools, tmux"
    echo "â€¢ Filesystem: Claude tools access host files directly"
    echo "â€¢ Ports: 3000, 5000, 8000, 8080, 8443, 9000 forwarded"
    echo "â€¢ VSCode: Use 'code .' or dev container for remote development"
else
    echo "â€¢ Status: Available - Use './setup-workflow.sh --docker' to enable"
    echo "â€¢ Benefits: Isolated execution, consistent Ubuntu environment"
    echo "â€¢ Fallback: Native mode active (commands run on host)"
fi
echo "=== AI-WORKFLOW TMUX SYSTEM ==="
echo

# Detect execution environment
DOCKER_MODE=false
CONTAINER_NAME="ai-workflow-dev"
if [ "$AI_WORKFLOW_MODE" = "docker" ] || [ -f /.dockerenv ]; then
    DOCKER_MODE=true
fi

# Show environment information
if [ "$DOCKER_MODE" = "true" ]; then
    echo "ENVIRONMENT: ğŸ³ Docker Container (Ubuntu 22.04 LTS)"
    echo "CONTAINER: $CONTAINER_NAME"
    echo "WORKSPACE: /workspace (mapped from host)"
else
    echo "ENVIRONMENT: ğŸ–¥ï¸  Native ($(uname -s))"
    echo "WORKSPACE: $(pwd)"
fi
echo

# Check if session exists
if tmux has-session -t ai-workflow 2>/dev/null; then
    echo "STATUS: ai-workflow session ACTIVE"
    
    # Show session layout
    echo
    echo "LAYOUT: 3-pane setup"
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚             â”‚     TOP     â”‚"
    echo "â”‚    LEFT     â”‚  (pane 0.1) â”‚"
    echo "â”‚  (pane 0.0) â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚             â”‚   BOTTOM    â”‚"
    echo "â”‚             â”‚  (pane 0.2) â”‚"
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo
    
    # Check current state of each pane
    echo "PANE STATUS:"
    for pane in 0 1 2; do
        pane_name=""
        case $pane in
            0) pane_name="LEFT" ;;
            1) pane_name="TOP" ;;
            2) pane_name="BOTTOM" ;;
        esac
        
        # Capture last line to check prompt
        last_line=$(tmux capture-pane -t ai-workflow:0.$pane -p | tail -1)
        
        if [[ "$last_line" == *"ai-workflow-bash:$pane_name"* ]]; then
            if [[ "$last_line" == *"ğŸ³"* ]]; then
                echo "  $pane_name: âœ“ Ready (Docker mode, proper prompt detected)"
            else
                echo "  $pane_name: âœ“ Ready (Native mode, proper prompt detected)"
            fi
        else
            echo "  $pane_name: ? Unknown state - last line: $last_line"
        fi
    done
    
else
    echo "STATUS: ai-workflow session NOT FOUND"
    echo "RUN: ./setup-workflow.sh to create session"
fi

echo
echo "=== ğŸ§  SERENA INTEGRATION ==="
echo "â€¢ Memory Hub: Use 'serena' project for persistent context across sessions"
echo "â€¢ Key Memories: ai-workflow-system-overview, ai-token-optimization-research"
echo "â€¢ Access Pattern: Serena:activate_project('serena') â†’ Serena:read_memory('memory-name')"
echo "â€¢ Documentation: Serena:write_memory() to save important discoveries/context"
echo "â€¢ Shell Access: Serena:execute_shell_command() for tmux operations"
echo

echo "=== ğŸ“ FILESYSTEM TOOLS INTEGRATION ==="
echo "â€¢ File Access: filesystem:read_file('/full/path/to/file') for ANY directory"
echo "â€¢ Safe Inspection: ALWAYS read before modifying files"
echo "â€¢ File Creation: filesystem:write_file('/path', 'content') with explicit content"
echo "â€¢ Directory Ops: filesystem:list_directory(), filesystem:search_files()"
echo "â€¢ Multi-file: filesystem:read_multiple_files(['path1', 'path2'])"
echo "â€¢ Safety: Time Machine backups provide recovery safety net"
echo "â€¢ Coverage: Full access to ~/devel, ~/ted, and any other directories"
echo

echo "=== ğŸ¤– AI TOKEN OPTIMIZATION (Research Complete) ==="
echo "â€¢ Two-Tier Architecture: Claude (strategy) + phi3/Ollama (routine tasks)"
echo "â€¢ Handoff Pattern: Natural language â†’ phi3 translation â†’ tmux â†’ phi3 cleanup â†’ Claude"
echo "â€¢ Token Savings: Local AI handles parsing/translation, Claude focuses on reasoning"
echo "â€¢ Implementation: phi3-simulator.py demonstrates the pattern"
echo "â€¢ Test Suite: Comprehensive validation in tests/ directory"
echo "â€¢ Benefits: Speed, cost efficiency, reliability, scalability"
echo

echo "=== âš ï¸  CRITICAL SAFETY RULES âš ï¸  ==="
echo "1. NEVER use heredoc syntax (cat << EOF) - ALWAYS use base64 encoding"
echo "2. If pane is stuck, DO NOT run recovery commands IN that pane"
echo "3. Run recovery commands from OUTSIDE tmux or in a different pane"
echo "4. Always add newline after EOF markers to avoid confusion"
echo "5. When in doubt, use base64: echo 'content' | base64 | base64 -d > file"
echo "6. Use filesystem tools CAREFULLY - inspect before modifying"
echo "7. Store important context in Serena memories for persistence"
echo
echo "â€¢ Use natural language: 'Run [command] in the [left|top|bottom] pane'"
echo "â€¢ tmux targets: ai-workflow:0.0 (left), ai-workflow:0.1 (top), ai-workflow:0.2 (bottom)"
echo "â€¢ Expected prompts: 'ai-workflow-bash:[PANE_NAME] $ '"
echo "â€¢ For commands expected to finish: add 'timeout [duration] [command] ; echo ; echo \"program execution done. exit_code=\$?\"'"
echo "â€¢ For text injection: use base64 encoding + 'base64 -d | tee filename.txt'"
echo "â€¢ NEVER use heredoc syntax - causes shell escaping issues"

echo
echo "=== TIMEOUT RECOMMENDATIONS ==="
echo "â€¢ Quick commands (ls, cd): 5-10 seconds"
echo "â€¢ Build commands: 60-300 seconds"
echo "â€¢ Test suites: 300-600 seconds"
echo "â€¢ Interactive programs: No timeout, monitor state instead"

echo
echo "=== OPERATIONAL COMMAND PATTERNS ==="
echo "â€¢ tmux control: tmux send-keys -t ai-workflow:0.[0|1|2] '[command]' Enter"
echo "â€¢ tmux capture: tmux capture-pane -t ai-workflow:0.[0|1|2] -p"
echo "â€¢ tmux state: tmux capture-pane -t ai-workflow:0.[0|1|2] -S -10"
echo "â€¢ Serena memory: Serena:read_memory('memory-name')"
echo "â€¢ Serena shell: Serena:execute_shell_command('command')"
echo "â€¢ File read: filesystem:read_file('/full/path')"
echo "â€¢ File write: filesystem:write_file('/path', 'content')"
echo "â€¢ Directory list: filesystem:list_directory('/path')"

echo
echo "=== TROUBLESHOOTING STUCK SESSIONS ==="
echo "â€¢ Stuck in heredoc (> prompt): Send Ctrl+C, then clear"
echo "â€¢ Hanging command: Send Ctrl+C to interrupt"
echo "â€¢ Frozen terminal: Send Ctrl+L to refresh screen"
echo "â€¢ Wrong directory: Use 'cd' to navigate back"
echo "â€¢ Garbled output: Type 'reset' and press Enter"
echo "â€¢ Process won't die: Try Ctrl+C, then Ctrl+Z, then 'kill %1'"
echo "â€¢ Clear screen: Type 'clear' and press Enter"
echo "â€¢ Emergency reset: Type 'stty sane' and press Enter"
echo
echo "=== RECOVERY COMMANDS FOR AI ==="
echo "âš ï¸  CRITICAL: Run these from OUTSIDE the stuck pane or OUTSIDE tmux entirely"
echo "â€¢ Check pane state: tmux capture-pane -t ai-workflow:0.[0|1|2] -p | tail -3"
echo "â€¢ Send Ctrl+C: tmux send-keys -t ai-workflow:0.[0|1|2] C-c"
echo "â€¢ Send clear: tmux send-keys -t ai-workflow:0.[0|1|2] 'clear' Enter"
echo "â€¢ Reset terminal: tmux send-keys -t ai-workflow:0.[0|1|2] 'reset' Enter"
echo "â€¢ Navigate home: tmux send-keys -t ai-workflow:0.[0|1|2] 'cd' Enter"
echo "â€¢ Use recovery script: ./tmux-recover [pane] [action] (run from outside tmux)"

echo
echo "=== ğŸ¯ INTEGRATED WORKFLOW PATTERN ==="
echo "1. Activate Serena: Serena:activate_project('serena')"
echo "2. Load context: Serena:read_memory('relevant-context')"
echo "3. Check tmux: ./tmux-hello (this script)"
echo "4. File operations: filesystem:read_file() â†’ inspect â†’ filesystem:write_file()"
echo "5. tmux commands: Serena:execute_shell_command() for tmux operations"
echo "6. Save context: Serena:write_memory() for important discoveries"
echo "7. AI collaboration: Natural language â†’ phi3 translation â†’ structured results"
echo
echo "=== READY FOR AI COLLABORATION ==="
